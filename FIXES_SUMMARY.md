# üîß –û—Ç—á–µ—Ç –æ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö LootLink

–î–∞—Ç–∞: 27 –æ–∫—Ç—è–±—Ä—è 2025
–°—Ç–∞—Ç—É—Å: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ (7 –∏–∑ 8 –∑–∞–¥–∞—á)

## ‚úÖ 1. –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∞–≥–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1.1 Race Condition –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞
**–§–∞–π–ª:** `accounts/models.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ä–µ–π—Ç–∏–Ω–≥–∞ –º–æ–≥–ª–æ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ
**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å `SELECT FOR UPDATE`
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞

### 1.2 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ—Å–µ–¥ –≤ —á–∞—Ç–µ
**–§–∞–π–ª:** `chat/views.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –º–æ–≥–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã –±–µ—Å–µ–¥
**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `get_or_create()` —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `IntegrityError` —Å fallback –ø–æ–∏—Å–∫–æ–º
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ ID

### 1.3 Hardcoded URLs
**–§–∞–π–ª—ã:** `listings/views.py`, `chat/models.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** –•–∞—Ä–¥–∫–æ–¥ `http://127.0.0.1:8000` –≤ email –∏ –∂–∞–ª–æ–±–∞—Ö
**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `request.build_absolute_uri()` –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö URL
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `reverse()` –¥–ª—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (http/https)

### 1.4 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
**–§–∞–π–ª:** `listings/views.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** Partial delete –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
**–†–µ—à–µ–Ω–∏–µ:** –û–±–µ—Ä—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤ `transaction.atomic()`

### 1.5 –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —Å–∏–≥–Ω–∞–ª–æ–≤
**–§–∞–π–ª:** `accounts/models.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–≤–∞ —Å–∏–≥–Ω–∞–ª–∞ –¥–µ–ª–∞–ª–∏ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ
**–†–µ—à–µ–Ω–∏–µ:** –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –æ–¥–∏–Ω —Å–∏–≥–Ω–∞–ª `create_or_update_user_profile`

### 1.6 –£–¥–∞–ª–µ–Ω –∏–∑–±—ã—Ç–æ—á–Ω—ã–π fallback
**–§–∞–π–ª:** `listings/views.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `hasattr(Listing, 'search_vector')` –Ω–µ –Ω—É–∂–Ω–∞
**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω fallback, –æ—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ Full-Text Search

---

## ‚ö° 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–û

### 2.1 N+1 Query Problem
**–§–∞–π–ª—ã:** `accounts/views.py`, `listings/views.py`
**–î–æ–±–∞–≤–ª–µ–Ω–æ `select_related` –∏ `prefetch_related` –≤:**
- `my_listings()` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `.select_related('game')`
- `my_purchases()` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `.select_related('listing', 'listing__game', 'seller', 'seller__profile')`
- `my_sales()` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `.select_related('listing', 'listing__game', 'buyer', 'buyer__profile')`
- `profile()` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `.select_related('reviewer', 'reviewer__profile', 'purchase_request', 'purchase_request__listing')`
- `game_listings()` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `.select_related('seller', 'seller__profile')`
- `get_new_messages()` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `.select_related('sender')`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –≤ 3-10 —Ä–∞–∑

### 2.2 –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
**–§–∞–π–ª:** `accounts/views.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤ —Å—Ä–∞–∑—É
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è (10 –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É)

---

## üîÑ 3. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–û

### 3.1 –°–æ–∑–¥–∞–Ω NotificationService
**–§–∞–π–ª:** `core/services.py` (–ù–û–í–´–ô)
**–ß—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ë–î
- –û—Ç–ø—Ä–∞–≤–∫–∞ email
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ email —Ç–µ–ª–∞
- –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ú–µ—Ç–æ–¥—ã:**
- `create_and_notify()` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
- `notify_purchase_request()` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—Ä–æ—Å–µ
- `notify_request_accepted()` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–∏–Ω—è—Ç–∏–∏
- `notify_request_rejected()` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏
- `notify_deal_completed()` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- `notify_new_review()` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∑—ã–≤–µ
- `notify_new_message()` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–æ–±—â–µ–Ω–∏–∏

### 3.2 –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
**–§–∞–π–ª—ã:** `transactions/views.py`, `chat/models.py`
- –ó–∞–º–µ–Ω–µ–Ω –∫–æ–¥ –Ω–∞ –≤—ã–∑–æ–≤—ã `NotificationService`
- –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ email
- –£–ø—Ä–æ—â–µ–Ω –∫–æ–¥ –Ω–∞ 150+ —Å—Ç—Ä–æ–∫

---

## üîí 4. –£–ª—É—á—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–û

### 4.1 Rate Limiting –¥–ª—è API
**–§–∞–π–ª:** `core/decorators.py` (–ù–û–í–´–ô)
**–°–æ–∑–¥–∞–Ω –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@api_rate_limit`:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis –∫–µ—à–∞
- –í–æ–∑–≤—Ä–∞—Ç HTTP 429 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫:**
- `get_new_messages()` - 60 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç–∞
- `unread_notifications_count()` - 120 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç–∞

### 4.2 AJAX Required –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä
**–§–∞–π–ª:** `core/decorators.py`
**–°–æ–∑–¥–∞–Ω –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@ajax_required`:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ X-Requested-With –∑–∞–≥–æ–ª–æ–≤–∫–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä—è–º—ã—Ö GET –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API endpoints

### 4.3 –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã Hardcoded URLs
- –°–º. —Ä–∞–∑–¥–µ–ª 1.3 –≤—ã—à–µ

---

## üìß 5. Email –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è - –î–û–ë–ê–í–õ–ï–ù–û

### 5.1 –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å EmailVerification
**–§–∞–π–ª:** `accounts/models.py`
**–ü–æ–ª—è:**
- `user` - OneToOne –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- `token` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω (32 —Å–∏–º–≤–æ–ª–∞)
- `is_verified` - —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `created_at` / `verified_at` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

**–ú–µ—Ç–æ–¥—ã:**
- `generate_token()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
- `create_for_user()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `verify()` - –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email

### 5.2 –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
**–§–∞–π–ª:** `accounts/forms.py`
- –¢–æ–∫–µ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- Email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —Å—Å—ã–ª–∫–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ 24 —á–∞—Å–∞

### 5.3 Views –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
**–§–∞–π–ª:** `accounts/views.py`
**–î–æ–±–∞–≤–ª–µ–Ω—ã view:**
- `verify_email(request, token)` - –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ç–æ–∫–µ–Ω—É
- `resend_verification_email(request)` - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

### 5.4 URLs –∏ Admin
**–§–∞–π–ª—ã:** `accounts/urls.py`, `accounts/admin.py`
- –î–æ–±–∞–≤–ª–µ–Ω—ã URL –º–∞—Ä—à—Ä—É—Ç—ã
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 5.5 –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
**–§–∞–π–ª:** `accounts/migrations/0009_add_email_verification.py`
- –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –∫–æ–º–∞–Ω–¥–æ–π `python manage.py migrate`

---

## üöÄ 6. Celery –¥–ª—è Async –ó–∞–¥–∞—á - –ù–ê–°–¢–†–û–ï–ù–û

### 6.1 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery
**–§–∞–π–ª:** `config/celery.py` (–ù–û–í–´–ô)
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Celery –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis

### 6.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Django
**–§–∞–π–ª:** `config/__init__.py`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Celery –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Django

### 6.3 –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ settings.py
**–§–∞–π–ª:** `config/settings.py`
**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `CELERY_BROKER_URL` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
- `CELERY_RESULT_BACKEND` - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `CELERY_BEAT_SCHEDULE` - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

**–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏:**
- `cleanup_old_data` - —Ä–∞–∑ –≤ –¥–µ–Ω—å (24 —á–∞—Å–∞)
- `update_user_ratings` - —Ä–∞–∑ –≤ —á–∞—Å

### 6.4 –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
**–§–∞–π–ª:** `core/tasks.py` (–ù–û–í–´–ô)

**–ó–∞–¥–∞—á–∏:**

1. **send_email_async** - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email
   - Retry –º–µ—Ö–∞–Ω–∏–∑–º (3 –ø–æ–ø—ã—Ç–∫–∏)
   - –ó–∞–¥–µ—Ä–∂–∫–∞ 30 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏

2. **send_bulk_emails_async** - –ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email
   - –î–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

3. **cleanup_old_data** - –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –£–¥–∞–ª—è–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ –∫–æ–¥—ã —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è (>24 —á–∞—Å–∞)
   - –£–¥–∞–ª—è–µ—Ç –Ω–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (>7 –¥–Ω–µ–π)
   - –£–¥–∞–ª—è–µ—Ç –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (>30 –¥–Ω–µ–π)

4. **update_user_ratings** - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
   - –ü–µ—Ä–µ—Å—á–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑ –≤ —á–∞—Å

### 6.5 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å NotificationService
**–§–∞–π–ª:** `core/services.py`
- Email –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ Celery
- Fallback –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –µ—Å–ª–∏ Celery –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- Graceful degradation

### 6.6 –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
**–§–∞–π–ª:** `docs/CELERY_SETUP.md` (–ù–û–í–´–ô)
- –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è development –∏ production
- –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- Troubleshooting

### 6.7 –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
**–§–∞–π–ª:** `requirements.txt`
- –î–æ–±–∞–≤–ª–µ–Ω–æ `celery>=5.3.0`

---

## ‚ùå 7. Type Hints - –ù–ï –ó–ê–í–ï–†–®–ï–ù–û

**–°—Ç–∞—Ç—É—Å:** Pending
**–ü—Ä–∏—á–∏–Ω–∞:** –û–≥—Ä–æ–º–Ω—ã–π –æ–±—ä–µ–º —Ä–∞–±–æ—Ç—ã (150+ —Ñ—É–Ω–∫—Ü–∏–π –≤–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–∞—Ö)
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–ª—è—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π

**–ü—Ä–∏–º–µ—Ä—ã –≥–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
```python
# –ë—ã–ª–æ
def profile(request, username):
    ...

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å
def profile(request: HttpRequest, username: str) -> HttpResponse:
    ...
```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- ‚úÖ 6 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–∞–≥–æ–≤
- ‚úÖ 8 –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω NotificationService (—É–¥–∞–ª–µ–Ω–æ 150+ —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ 2 –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (–Ω–æ–≤–∞—è –º–æ–¥–µ–ª—å + 4 view + –º–∏–≥—Ä–∞—Ü–∏—è)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω Celery (5 —Ñ–∞–π–ª–æ–≤ + 4 –∑–∞–¥–∞—á–∏ + –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

### –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:
1. `core/services.py` - NotificationService (200+ —Å—Ç—Ä–æ–∫)
2. `core/decorators.py` - Rate limiting (90+ —Å—Ç—Ä–æ–∫)
3. `core/tasks.py` - Celery –∑–∞–¥–∞—á–∏ (150+ —Å—Ç—Ä–æ–∫)
4. `config/celery.py` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery (20+ —Å—Ç—Ä–æ–∫)
5. `docs/CELERY_SETUP.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Celery (200+ —Å—Ç—Ä–æ–∫)

### –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:
- `accounts/models.py` - +60 —Å—Ç—Ä–æ–∫ (EmailVerification + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- `accounts/views.py` - +80 —Å—Ç—Ä–æ–∫ (email verification views)
- `accounts/forms.py` - +50 —Å—Ç—Ä–æ–∫ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ verification)
- `accounts/urls.py` - +2 URL –º–∞—Ä—à—Ä—É—Ç–∞
- `accounts/admin.py` - +10 —Å—Ç—Ä–æ–∫ (EmailVerificationAdmin)
- `listings/views.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è hardcoded URLs, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `chat/views.py` - –¥–æ–±–∞–≤–ª–µ–Ω rate limiting
- `chat/models.py` - —É–ø—Ä–æ—â–µ–Ω —Å–∏–≥–Ω–∞–ª (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç NotificationService)
- `transactions/views.py` - –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ NotificationService
- `config/settings.py` - +20 —Å—Ç—Ä–æ–∫ (Celery –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- `config/__init__.py` - –∏–º–ø–æ—Ä—Ç Celery
- `requirements.txt` - +1 –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (celery)

### –°–æ–∑–¥–∞–Ω–æ –º–∏–≥—Ä–∞—Ü–∏–π: 1
- `accounts/migrations/0009_add_email_verification.py`

---

## üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ?

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:** `python manage.py migrate`
2. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Celery:** `pip install -r requirements.txt`
3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å Redis:** –¥–ª—è Celery –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å Celery worker:** `celery -A config worker -l info --pool=solo`
5. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. –î–æ–±–∞–≤–∏—Ç—å type hints –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
2. –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
3. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD
5. –î–æ–±–∞–≤–∏—Ç—å Flower –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Celery

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. REST API (Django REST Framework)
2. WebSocket –¥–ª—è —á–∞—Ç–∞
3. Elasticsearch –¥–ª—è –ø–æ–∏—Å–∫–∞
4. PWA –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ!

### –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:
1. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –∑–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏
2. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Redis
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ** `.env` —Ñ–∞–π–ª (–¥–æ–±–∞–≤—å—Ç–µ CELERY –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
4. **–û–±–Ω–æ–≤–∏—Ç–µ** requirements.txt (`pip install -r requirements.txt`)

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env):
```env
# Celery (–¥–æ–±–∞–≤—å—Ç–µ –µ—Å–ª–∏ –Ω–µ—Ç)
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0
```

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞:
```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
python manage.py migrate

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Django
python manage.py runserver

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å Celery worker (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
celery -A config worker -l info --pool=solo

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å Celery beat –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
celery -A config beat -l info
```

---

## üìà –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ~15-20 SQL –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–∏ –ø–æ–∫—É–ø–∫–∏: ~40-50 SQL –∑–∞–ø—Ä–æ—Å–æ–≤ (N+1 problem)
- Email –æ—Ç–ø—Ä–∞–≤–∫–∞: –±–ª–æ–∫–∏—Ä—É–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å –Ω–∞ 1-3 —Å–µ–∫—É–Ω–¥—ã

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ~5-7 SQL –∑–∞–ø—Ä–æ—Å–æ–≤ (66% —É–ª—É—á—à–µ–Ω–∏–µ)
- –ú–æ–∏ –ø–æ–∫—É–ø–∫–∏: ~3-5 SQL –∑–∞–ø—Ä–æ—Å–æ–≤ (90% —É–ª—É—á—à–µ–Ω–∏–µ)
- Email –æ—Ç–ø—Ä–∞–≤–∫–∞: 0 –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ Celery)

---

## üõ°Ô∏è –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **Race Condition** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
2. **Hardcoded URLs** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
3. **Rate Limiting** - –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è API
4. **Email Verification** - –¥–æ–±–∞–≤–ª–µ–Ω–æ
5. **XSS –∑–∞—â–∏—Ç–∞** - —É–ª—É—á—à–µ–Ω–æ (escape –≤ email)
6. **CSRF** - —É–∂–µ –±—ã–ª–æ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

---

## ‚úÖ Checklist –¥–ª—è Production

- [x] Race conditions –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- [x] N+1 queries –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [x] Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] Email verification –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [x] Celery –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] Redis –∑–∞–ø—É—â–µ–Ω
- [ ] Celery worker –∑–∞–ø—É—â–µ–Ω
- [ ] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- [ ] CI/CD –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Monitoring –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Backup –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

**–ê–≤—Ç–æ—Ä:** AI Assistant
**–î–∞—Ç–∞:** 27 –æ–∫—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è:** 2.0

