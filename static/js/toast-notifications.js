/**
 * –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
 * Toast –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ù–û–í–´–• —Å–æ–±—ã—Ç–∏–π, –ù–ï –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
 */

// –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
let toastSystemInitialized = false;

// –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    if (toastSystemInitialized) {
        console.log('‚ö†Ô∏è Toast —Å–∏—Å—Ç–µ–º–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
        return;
    }
    toastSystemInitialized = true;
    
    console.log('üîî Toast notifications initialized');
    
    // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è toast –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed';
        toastContainer.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 99999;
            pointer-events: none;
        `;
        document.body.appendChild(toastContainer);
        console.log('‚úÖ Toast container —Å–æ–∑–¥–∞–Ω');
    }
    
    // –°–ö–†–´–í–ê–ï–ú Django messages (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –∫–∞–∫ Toast)
    // –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É Notification
    const djangoMessages = document.querySelectorAll('.django-messages-data .alert');
    if (djangoMessages.length > 0) {
        console.log(`üì® Django messages —Å–∫—Ä—ã—Ç—ã: ${djangoMessages.length}`);
        djangoMessages.forEach(alert => alert.remove());
        
        const messagesContainer = document.querySelector('.django-messages-data');
        if (messagesContainer) {
            messagesContainer.remove();
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ AJAX
    if (typeof updateNotificationBadge !== 'undefined') {
        checkNewNotifications();
    }
});

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–ª—è real-time Toast)
 */
function checkNewNotifications() {
    // –ü–æ–ª—É—á–∞–µ–º timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑ localStorage
    const lastCheck = localStorage.getItem('lastNotificationCheck');
    const now = Date.now();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª–µ–µ 10 —Å–µ–∫—É–Ω–¥ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (lastCheck && (now - parseInt(lastCheck)) < 10000) {
        return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    localStorage.setItem('lastNotificationCheck', now.toString());
    
    // TODO: –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    // –∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å Toast —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ù–û–í–´–• —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
}

/**
 * –ü–æ–∫–∞–∑–∞—Ç—å toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
 */
function showToast(message, type = 'info', icon = 'info-circle', bgClass = 'bg-primary') {
    const toastContainer = document.getElementById('toast-container');
    
    const toastId = 'toast-' + Date.now();
    
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${icon} me-2"></i>
                    <strong>${message}</strong>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
window.showToast = showToast;

