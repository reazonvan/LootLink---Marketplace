<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ other_user.username }} - –ß–∞—Ç - LootLink</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/chat-improvements-v2.css' %}">
    
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        overflow: hidden;
        background: #F9FAFB;
    }
    
    /* Fullscreen Chat Layout */
    .chat-fullscreen {
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    /* Fixed Header */
    .chat-header-fixed {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        border-bottom: 1px solid #E5E7EB;
        padding: 16px 24px;
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .chat-avatar-wrapper {
        position: relative;
    }
    
    /* Messages Area - Scrollable */
    .chat-messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 90px 24px 100px 24px;
        background: #F9FAFB;
    }
    
    .chat-messages-container {
        max-width: 1000px;
        margin: 0 auto;
    }
    
    /* Fixed Input */
    .chat-input-fixed {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #E5E7EB;
        padding: 18px 24px;
        z-index: 100;
        box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
    }
    
    .chat-input-wrapper {
        max-width: 1000px;
        margin: 0 auto;
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .chat-input-field {
        flex: 1;
        border: 2px solid #E5E7EB;
        border-radius: 24px;
        padding: 14px 22px;
        font-size: 16px; /* –ú–∏–Ω–∏–º—É–º 16px –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∞–≤—Ç–æ-–∑—É–º–∞ –Ω–∞ iOS */
        outline: none;
        transition: all 0.2s;
        background: #F9FAFB;
    }
    
    .chat-input-field:focus {
        border-color: #0066FF;
        box-shadow: 0 0 0 4px rgba(0, 102, 255, 0.1);
        background: white;
    }
    
    .chat-send-btn {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: #0066FF;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .chat-send-btn:hover {
        background: #0052CC;
        transform: scale(1.08);
    }
    
    .chat-send-btn:active {
        transform: scale(0.95);
    }
    
    /* Message Groups - Like Telegram */
    .message-group {
        position: relative;
        margin-bottom: 16px;
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }
    
    .message-group.sent {
        flex-direction: row-reverse;
    }
    
    .message-group-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #E5E7EB;
        flex-shrink: 0;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        position: sticky;
        top: 90px; /* –ù–∏–∂–µ header'–∞ */
        align-self: flex-start;
        z-index: 10;
    }
    
    .message-group-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .message-group-avatar i {
        font-size: 20px;
        color: #9CA3AF;
    }
    
    .messages-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
    }
    
    .message-item {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .message-group.sent .message-item {
        align-items: flex-end;
    }
    
    /* –°—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
    .message-avatar-chat {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #E5E7EB;
        flex-shrink: 0;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .message-avatar-chat.hidden {
        display: none;
    }
    
    .message-avatar-chat img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .message-avatar-chat i {
        font-size: 20px;
        color: #9CA3AF;
    }
    
    .message-content-box {
        display: flex;
        flex-direction: column;
        max-width: 100%;
        min-width: 120px;
    }
    
    .message-group.sent .message-content-box {
        align-items: flex-end;
    }
    
    .messages-wrapper .message-item {
        max-width: 70%;
    }
    
    .message-group.sent .messages-wrapper .message-item {
        max-width: 70%;
        align-self: flex-end;
    }
    
    .message-bubble-chat {
        padding: 14px 18px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.6;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
    }
    
    .message-bubble-chat.received {
        background: white;
        color: #111827;
        border: 1px solid #E5E7EB;
        border-bottom-left-radius: 6px;
    }
    
    .message-bubble-chat.sent {
        background: #0066FF;
        color: white;
        border-bottom-right-radius: 6px;
    }
    
    .message-timestamp {
        font-size: 11px;
        color: #9CA3AF;
        margin-top: 6px;
        padding: 0 6px;
    }
    
    /* Mobile Adjustments */
    @media (max-width: 768px) {
        .messages-wrapper .message-item {
            max-width: 85%; /* Mobile - –ø–æ—á—Ç–∏ –¥–æ –∫—Ä–∞—è */
        }
        
        .chat-messages-area {
            padding: 90px 15px 90px 15px; /* –£–≤–µ–ª–∏—á–µ–Ω –≤–µ—Ä—Ö–Ω–∏–π padding —á—Ç–æ–±—ã –Ω–µ –∑–∞–µ–∑–∂–∞–ª–æ –ø–æ–¥ header */
        }
        
        .chat-header-fixed {
            padding: 12px 15px;
        }
        
        .chat-input-fixed {
            padding: 12px 15px;
        }
        
        .chat-input-field {
            font-size: 16px !important; /* –ú–∏–Ω–∏–º—É–º 16px —á—Ç–æ–±—ã iOS –Ω–µ –∑—É–º–∏–ª */
            padding: 14px 20px;
        }
        
        .chat-send-btn {
            width: 52px;
            height: 52px;
            font-size: 20px;
        }
    }
    
    /* Empty State */
    .empty-chat-state {
        text-align: center;
        padding: 60px 20px;
        color: #9CA3AF;
    }
    
    .empty-chat-state i {
        font-size: 64px;
        margin-bottom: 16px;
    }
    
    /* Connection Status - Modern Design */
    .connection-status {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        backdrop-filter: blur(10px);
        animation: slideDown 0.3s ease-out;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .connection-status.connected {
        background: rgba(16, 185, 129, 0.95);
        color: white;
    }
    
    .connection-status.disconnected {
        background: rgba(251, 191, 36, 0.95);
        color: #78350f;
    }
    
    .connection-status.error {
        background: rgba(239, 68, 68, 0.95);
        color: white;
    }
    
    .connection-status::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
    }
    
    .connection-status.disconnected::before {
        animation: spin 1s linear infinite;
        width: 16px;
        height: 16px;
        border: 2px solid currentColor;
        border-top-color: transparent;
        background: none;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }
    
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
    </style>
</head>
<body>

<div class="chat-fullscreen" data-conversation-id="{{ conversation.pk }}">
    <!-- Fixed Header -->
    <div class="chat-header-fixed">
        <a href="{% url 'chat:conversations_list' %}" class="btn btn-sm btn-light" style="border-radius:8px;">
            <i class="bi bi-arrow-left"></i>
        </a>
        
        <div class="chat-avatar-wrapper" style="position:relative;">
            {% if other_user.profile.avatar %}
            <img src="{{ other_user.profile.avatar.url }}" alt="{{ other_user.username }}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #E5E7EB;">
            {% else %}
            <div style="width:48px;height:48px;border-radius:50%;background:#F3F4F6;display:flex;align-items:center;justify-content:center;border:2px solid #E5E7EB;">
                <i class="bi bi-person-fill" style="font-size:22px;color:#9CA3AF;"></i>
            </div>
            {% endif %}
            {% if other_user.profile.get_online_status == 'online' %}
            <span style="position:absolute;bottom:2px;right:2px;width:14px;height:14px;border-radius:50%;border:3px solid white;background:#10B981;"></span>
            {% else %}
            <span style="position:absolute;bottom:2px;right:2px;width:14px;height:14px;border-radius:50%;border:3px solid white;background:#9CA3AF;"></span>
            {% endif %}
        </div>
        
        <div style="flex:1;min-width:0;">
            <h6 style="margin:0;font-weight:600;font-size:17px;line-height:1.3;">
                <a href="{% url 'accounts:profile' other_user.username %}" style="color:#111827;text-decoration:none;">{{ other_user.username }}</a>
            </h6>
            <p style="margin:2px 0 0 0;font-size:13px;color:#6B7280;line-height:1.2;">{{ other_user.profile.get_last_seen_display }}</p>
        </div>
        
        {% if conversation.listing %}
        <a href="{% url 'listings:listing_detail' conversation.listing.pk %}" class="btn btn-sm btn-outline-primary" style="border-radius:8px;">
            <i class="bi bi-box"></i>
        </a>
        {% endif %}
    </div>
    
    <!-- Messages Area - Scrollable -->
    <div class="chat-messages-area" id="messagesList">
        <div class="chat-messages-container" id="messages-container">
            {% if messages %}
                {% for message in messages %}
                <div class="message-item {% if message.sender == user %}sent{% else %}received{% endif %}" data-message-id="{{ message.id }}" data-sender-id="{{ message.sender.id }}">
                    {% if message.sender != user %}
                    <div class="message-avatar-chat">
                        {% if message.sender.profile.avatar %}
                        <img src="{{ message.sender.profile.avatar.url }}" alt="{{ message.sender.username }}">
                        {% else %}
                        <i class="bi bi-person-fill"></i>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="message-content-box">
                        <div class="message-bubble-chat {% if message.sender == user %}sent{% else %}received{% endif %}">
                            {{ message.content }}
                        </div>
                        <div class="message-timestamp">{{ message.created_at|date:"H:i" }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-chat-state">
                    <i class="bi bi-chat-left-text"></i>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –±–µ—Å–µ–¥—É, –æ—Ç–ø—Ä–∞–≤–∏–≤ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
                </div>
            {% endif %}
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–µ—Ç -->
            <div id="typing-indicator-container"></div>
        </div>
    </div>
    
    <!-- Fixed Input -->
    <div class="chat-input-fixed">
        <form method="post" id="message-form">
            {% csrf_token %}
            <div class="chat-input-wrapper">
                <input 
                    type="text"
                    id="id_content"
                    name="content" 
                    class="chat-input-field" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    required
                    autocomplete="off"
                />
                <button type="submit" class="chat-send-btn">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
<div id="connection-status" class="connection-status" style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// WebSocket Chat Implementation
class ChatWebSocket {
    constructor(conversationId, userId, username) {
        this.conversationId = conversationId;
        this.userId = userId;
        this.username = username;
        this.socket = null;
        this.typingTimeout = null;
        this.isTyping = false;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        
        this.messagesContainer = document.querySelector('.chat-messages-container');
        this.messagesArea = document.getElementById('messagesList');
        this.messageInput = document.getElementById('id_content');
        this.messageForm = document.getElementById('message-form');
        
        this.init();
    }
    
    init() {
        this.groupExistingMessages();
        this.connect();
        this.attachEventListeners();
        this.scrollToBottom();
    }
    
    groupExistingMessages() {
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const messages = this.messagesContainer.querySelectorAll('.message-item');
        let previousSenderId = null;
        let currentGroup = null;
        let messagesWrapper = null;
        
        messages.forEach((messageEl, index) => {
            const senderId = messageEl.dataset.senderId;
            const isSent = messageEl.classList.contains('sent');
            
            // –ï—Å–ª–∏ –Ω–æ–≤—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
            if (senderId !== previousSenderId) {
                // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É
                currentGroup = document.createElement('div');
                currentGroup.className = `message-group ${isSent ? 'sent' : 'received'}`;
                messageEl.parentNode.insertBefore(currentGroup, messageEl);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                if (!isSent) {
                    const avatar = messageEl.querySelector('.message-avatar-chat');
                    if (avatar) {
                        const groupAvatar = document.createElement('div');
                        groupAvatar.className = 'message-group-avatar';
                        groupAvatar.innerHTML = avatar.innerHTML;
                        currentGroup.appendChild(groupAvatar);
                        avatar.remove(); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∞–≤–∞—Ç–∞—Ä–∫—É
                    }
                }
                
                // –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
                messagesWrapper = document.createElement('div');
                messagesWrapper.className = 'messages-wrapper';
                currentGroup.appendChild(messagesWrapper);
            }
            
            // –£–¥–∞–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –∏–∑ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            const avatar = messageEl.querySelector('.message-avatar-chat');
            if (avatar) {
                avatar.remove();
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±–µ—Ä—Ç–∫—É
            if (messagesWrapper) {
                messagesWrapper.appendChild(messageEl);
            }
            
            previousSenderId = senderId;
        });
    }
    
    connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${this.conversationId}/`;
        
        console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket:', wsUrl);
        
        try {
            this.socket = new WebSocket(wsUrl);
            
            this.socket.onopen = () => {
                console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                this.reconnectAttempts = 0;
                this.showConnectionStatus('connected');
                this.useWebSocket = true;
            };
            
            this.socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleMessage(data);
            };
            
            this.socket.onclose = (event) => {
                console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', event.code, event.reason);
                this.showConnectionStatus('disconnected');
                this.useWebSocket = false;
                
                // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    const timeout = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 10000);
                    console.log(`üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${timeout}ms... (–ø–æ–ø—ã—Ç–∫–∞ ${this.reconnectAttempts})`);
                    setTimeout(() => this.connect(), timeout);
                } else {
                    console.warn('‚ö†Ô∏è WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º polling');
                    this.startPolling();
                }
            };
            
            this.socket.onerror = (error) => {
                console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
                this.showConnectionStatus('error');
            };
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket:', error);
            this.showConnectionStatus('error');
            console.warn('‚ö†Ô∏è Fallback –Ω–∞ polling');
            this.startPolling();
        }
    }
    
    startPolling() {
        // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π polling –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        console.log('üì° –ó–∞–ø—É—Å–∫ polling —Ä–µ–∂–∏–º–∞');
        this.pollingInterval = setInterval(() => {
            this.pollNewMessages();
        }, 3000);
    }
    
    async pollNewMessages() {
        const lastMessage = this.messagesContainer.querySelector('[data-message-id]:last-child');
        const lastId = lastMessage ? lastMessage.dataset.messageId : 0;
        
        try {
            const response = await fetch(`/chat/api/messages/${this.conversationId}/?after=${lastId}`);
            const data = await response.json();
            
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    this.addMessage({
                        id: msg.id,
                        content: msg.content,
                        sender_id: msg.is_own ? this.userId : null,
                        sender_username: msg.sender,
                        created_at: new Date().toISOString(),
                        is_read: false
                    });
                });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ polling:', error);
        }
    }
    
    handleMessage(data) {
        console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
        
        switch(data.type) {
            case 'message':
                this.addMessage(data.message);
                break;
            case 'typing':
                this.showTypingIndicator(data.username, data.is_typing);
                break;
            case 'status':
                this.updateUserStatus(data.username, data.status);
                break;
            case 'read':
                this.markMessageAsRead(data.message_id);
                break;
            case 'error':
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data.message);
                break;
        }
    }
    
    sendMessage(content) {
        if (!content.trim() || !this.socket || this.socket.readyState !== WebSocket.OPEN) {
            console.warn('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
            return false;
        }
        
        this.send({
            type: 'message',
            content: content.trim()
        });
        return true;
    }
    
    sendTypingIndicator(isTyping) {
        this.send({
            type: 'typing',
            is_typing: isTyping
        });
    }
    
    send(data) {
        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
            this.socket.send(JSON.stringify(data));
        }
    }
    
    addMessage(message) {
        const isSent = message.sender_id === this.userId;
        const time = new Date(message.created_at).toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≥—Ä—É–ø–ø—É —Å–æ–æ–±—â–µ–Ω–∏–π
        const allGroups = this.messagesContainer.querySelectorAll('.message-group');
        const lastGroup = allGroups[allGroups.length - 1];
        
        let targetGroup = null;
        let messagesWrapper = null;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ–º –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é –≥—Ä—É–ø–ø—É
        if (lastGroup) {
            const lastWrapper = lastGroup.querySelector('.messages-wrapper');
            const lastMessage = lastWrapper ? lastWrapper.querySelector('.message-item:last-child') : null;
            if (lastMessage) {
                const lastSenderId = lastMessage.dataset.senderId;
                if (lastSenderId === String(message.sender_id)) {
                    targetGroup = lastGroup;
                    messagesWrapper = lastWrapper;
                }
            }
        }
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â—É—é –≥—Ä—É–ø–ø—É - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
        if (!targetGroup) {
            targetGroup = document.createElement('div');
            targetGroup.className = `message-group ${isSent ? 'sent' : 'received'}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (!isSent) {
                const groupAvatar = document.createElement('div');
                groupAvatar.className = 'message-group-avatar';
                
                let avatarHTML = '<i class="bi bi-person-fill"></i>';
                if (message.sender_avatar_url) {
                    avatarHTML = `<img src="${message.sender_avatar_url}" alt="${message.sender_username}">`;
                }
                groupAvatar.innerHTML = avatarHTML;
                targetGroup.appendChild(groupAvatar);
            }
            
            // –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
            messagesWrapper = document.createElement('div');
            messagesWrapper.className = 'messages-wrapper';
            targetGroup.appendChild(messagesWrapper);
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É –ø–µ—Ä–µ–¥ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –ø–µ—á–∞—Ç–∏
            const typingContainer = document.getElementById('typing-indicator-container');
            if (typingContainer) {
                typingContainer.parentNode.insertBefore(targetGroup, typingContainer);
            } else {
                this.messagesContainer.appendChild(targetGroup);
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º HTML —Å–æ–æ–±—â–µ–Ω–∏—è (–±–µ–∑ –∞–≤–∞—Ç–∞—Ä–∫–∏ –≤–Ω—É—Ç—Ä–∏)
        const messageHTML = `
            <div class="message-item" data-message-id="${message.id}" data-sender-id="${message.sender_id}">
                <div class="message-content-box">
                    <div class="message-bubble-chat ${isSent ? 'sent' : 'received'}">
                        ${this.escapeHtml(message.content)}
                    </div>
                    <div class="message-timestamp">${time}</div>
                </div>
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±–µ—Ä—Ç–∫—É
        if (messagesWrapper) {
            messagesWrapper.insertAdjacentHTML('beforeend', messageHTML);
        }
        
        this.scrollToBottom();
    }
    
    showTypingIndicator(username, isTyping) {
        const container = document.getElementById('typing-indicator-container');
        if (!container) return;
        
        if (isTyping && username !== this.username) {
            if (!document.getElementById('typing-indicator')) {
                container.innerHTML = `
                    <div id="typing-indicator" style="padding-left: 52px; margin-top: 8px; opacity: 0.8;">
                        <div style="display: inline-block; background: white; border: 1px solid #E5E7EB; border-radius: 18px; padding: 10px 16px;">
                            <span class="typing-dots">
                                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#6B7280;margin:0 2px;animation:typing 1s infinite;"></span>
                                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#6B7280;margin:0 2px;animation:typing 1s infinite 0.2s;"></span>
                                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#6B7280;margin:0 2px;animation:typing 1s infinite 0.4s;"></span>
                            </span>
                        </div>
                    </div>
                    <style>
                    @keyframes typing {
                        0%, 60%, 100% { transform: translateY(0); }
                        30% { transform: translateY(-5px); }
                    }
                    </style>
                `;
                this.scrollToBottom();
            }
        } else {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
    }
    
    updateUserStatus(username, status) {
        console.log('–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', username, status);
        // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–Ω–ª–∞–π–Ω –≤ —Ö–µ–¥–µ—Ä–µ
    }
    
    markMessageAsRead(messageId) {
        const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageDiv) {
            console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ:', messageId);
        }
    }
    
    showConnectionStatus(status) {
        const statusEl = document.getElementById('connection-status');
        if (!statusEl) return;
        
        const messages = {
            'connected': '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ',
            'disconnected': '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...',
            'error': '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'
        };
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã —Å—Ç–∞—Ç—É—Å–∞
        statusEl.classList.remove('connected', 'disconnected', 'error');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å
        statusEl.classList.add(status);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç
        statusEl.textContent = messages[status] || '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º
        if (status === 'connected') {
            statusEl.style.display = 'flex';
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 2000);
        } else {
            statusEl.style.display = 'flex';
        }
    }
    
    attachEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        if (this.messageForm) {
            this.messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const content = this.messageInput.value.trim();
                if (content) {
                    const sent = this.sendMessage(content);
                    if (sent) {
                        this.messageInput.value = '';
                        this.isTyping = false;
                        this.sendTypingIndicator(false);
                    }
                }
            });
        }
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        if (this.messageInput) {
            this.messageInput.addEventListener('input', () => {
                if (!this.isTyping) {
                    this.isTyping = true;
                    this.sendTypingIndicator(true);
                }
                
                clearTimeout(this.typingTimeout);
                this.typingTimeout = setTimeout(() => {
                    this.isTyping = false;
                    this.sendTypingIndicator(false);
                }, 1000);
            });
            
            // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            this.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.messageForm.dispatchEvent(new Event('submit'));
                }
            });
        }
    }
    
    scrollToBottom() {
        if (this.messagesArea) {
            this.messagesArea.scrollTop = this.messagesArea.scrollHeight;
        }
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const conversationId = {{ conversation.pk }};
    const userId = {{ user.id }};
    const username = "{{ user.username }}";
    
    // –°–æ–∑–¥–∞–µ–º WebSocket —á–∞—Ç
    window.chatWS = new ChatWebSocket(conversationId, userId, username);
    
    // –ù–∞—á–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª
    const messagesArea = document.getElementById('messagesList');
    if (messagesArea) {
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }
});
</script>
</body>
</html>
