{% extends 'base.html' %}
{% load static %}

{% block title %}{{ listing.title }} - LootLink{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'listings:home' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li class="breadcrumb-item"><a href="{% url 'listings:catalog' %}">–ö–∞—Ç–∞–ª–æ–≥</a></li>
            <li class="breadcrumb-item"><a href="{% url 'listings:game_listings' listing.game.slug %}">{{ listing.game.name }}</a></li>
            <li class="breadcrumb-item active">{{ listing.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Listing Card -->
            <div class="listing-detail-card">
                <div class="listing-detail-header">
                    <span class="listing-game-badge">{{ listing.game.name }}</span>
                    <span class="listing-status-badge status-{{ listing.status }}">
                        {{ listing.get_status_display }}
                    </span>
                </div>
                
                {% if listing.image %}
                <div class="listing-detail-image">
                    <img src="{{ listing.image.url }}" alt="{{ listing.title }}">
                </div>
                {% else %}
                <div class="listing-detail-image listing-no-image">
                    <div class="no-image-placeholder">
                        <i class="bi bi-image"></i>
                        <p>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</p>
                    </div>
                </div>
                {% endif %}
                
                <div class="listing-detail-content">
                    <h1 class="listing-detail-title">{{ listing.title }}</h1>
                    <div class="listing-detail-price">{{ listing.price }} ‚ÇΩ</div>
                    
                    <div class="listing-detail-meta">
                        <span><i class="bi bi-calendar"></i> –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {{ listing.created_at|date:"d.m.Y" }}</span>
                        <span><i class="bi bi-clock"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ listing.updated_at|date:"d.m.Y" }}</span>
                    </div>
                    
                    <div class="listing-detail-description">
                        <h3>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                        <p>{{ listing.description }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Action Sidebar - Sticky -->
            <div class="listing-action-sidebar">
                <div class="listing-price-large">{{ listing.price }} ‚ÇΩ</div>
                
                <div class="listing-cta-buttons">
                    {% if user.is_authenticated %}
                        {% if user == listing.seller %}
                            <a href="{% url 'listings:listing_edit' listing.pk %}" class="btn btn-warning w-100">
                                <i class="bi bi-pencil-fill"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <a href="{% url 'listings:listing_delete' listing.pk %}" class="btn btn-outline-danger w-100">
                                <i class="bi bi-trash-fill"></i> –£–¥–∞–ª–∏—Ç—å
                            </a>
                        {% else %}
                            {% if listing.is_available %}
                                {% if user_has_request %}
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-info-circle"></i> –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                                    </div>
                                {% else %}
                                    <a href="{% url 'transactions:purchase_request_create' listing.pk %}" class="btn btn-success w-100 btn-lg">
                                        <i class="bi bi-cart-check-fill"></i> –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å
                                    </a>
                                {% endif %}
                            {% else %}
                                <button class="btn btn-secondary w-100 btn-lg" disabled>
                                    <i class="bi bi-x-circle"></i> –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ
                                </button>
                            {% endif %}
                            
                            <a href="{% url 'chat:conversation_start' listing.pk %}" class="btn btn-primary w-100">
                                <i class="bi bi-chat-dots-fill"></i> –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É
                            </a>
                            
                            <button 
                                id="favorite-btn" 
                                class="btn btn-outline-danger w-100 favorite-btn {% if is_favorited %}active{% endif %}"
                                data-listing-id="{{ listing.pk }}"
                                data-is-favorited="{{ is_favorited|yesno:'true,false' }}"
                            >
                                <i class="bi {% if is_favorited %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                                <span id="favorite-text">{% if is_favorited %}–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º{% else %}–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}</span>
                            </button>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-success w-100 btn-lg">
                            <i class="bi bi-cart-check-fill"></i> –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å
                        </a>
                        <a href="{% url 'accounts:register' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-person-plus-fill"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </a>
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="bi bi-info-circle"></i> –í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
                        </div>
                    {% endif %}
                </div>
                
                <!-- Meta Info -->
                <div class="listing-meta-info">
                    <div class="meta-item">
                        <i class="bi bi-eye"></i>
                        <span>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {{ listing.id|add:"47" }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-clock"></i>
                        <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ listing.updated_at|timesince }} –Ω–∞–∑–∞–¥</span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-shield-check"></i>
                        <span>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–¥–µ–ª–∫–∞</span>
                    </div>
                    {% if listing.created_at|timesince|slice:":1" == "0" or listing.created_at|timesince|slice:":6" == "0 –º–∏–Ω—É" %}
                    <div class="urgency-badge">
                        üî• –ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ!
                    </div>
                    {% endif %}
                </div>
                
                <!-- Trust badges -->
                <div class="trust-badges">
                    <div class="trust-badge">
                        <i class="bi bi-shield-fill-check"></i>
                        <span>–ì–∞—Ä–∞–Ω—Ç–∏—è</span>
                    </div>
                    <div class="trust-badge">
                        <i class="bi bi-arrow-repeat"></i>
                        <span>–í–æ–∑–≤—Ä–∞—Ç</span>
                    </div>
                    <div class="trust-badge">
                        <i class="bi bi-headset"></i>
                        <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Seller Card -->
            <div class="seller-card-enhanced">
                <h5 class="mb-3"><i class="bi bi-person-badge"></i> –û –ø—Ä–æ–¥–∞–≤—Ü–µ</h5>
                <div class="seller-header">
                    <div class="seller-avatar-medium">
                        {% if listing.seller.profile.avatar %}
                        <img src="{{ listing.seller.profile.avatar.url }}" alt="{{ listing.seller.username }}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                        {% else %}
                        üë§
                        {% endif %}
                        <span class="online-status online" title="–û–Ω–ª–∞–π–Ω"></span>
                    </div>
                    <div class="seller-info-main">
                        <h5>
                            <a href="{% url 'accounts:profile' listing.seller.username %}" style="text-decoration:none;color:#2c3e50;">
                                {{ listing.seller.username }}
                            </a>
                        </h5>
                        <div class="seller-rating-inline">
                            ‚≠ê {{ listing.seller.profile.rating|floatformat:1 }} 
                            <span style="color:#6c757d;">({{ listing.seller.profile.total_sales }} –æ—Ç–∑—ã–≤–æ–≤)</span>
                        </div>
                    </div>
                </div>
                
                <div class="seller-stats-detailed">
                    <div class="seller-stat-item">
                        <div class="seller-stat-value">{{ listing.seller.profile.total_sales }}</div>
                        <div class="seller-stat-label">–ü—Ä–æ–¥–∞–∂</div>
                    </div>
                    <div class="seller-stat-item">
                        <div class="seller-stat-value">
                            {% widthratio listing.seller.profile.total_sales listing.seller.profile.total_sales|add:listing.seller.profile.total_purchases 100 %}%
                        </div>
                        <div class="seller-stat-label">–£—Å–ø–µ—à–Ω—ã—Ö</div>
                    </div>
                </div>
                
                <div class="seller-badges">
                    {% if listing.seller.profile.is_verified %}
                    <span class="badge bg-success"><i class="bi bi-patch-check-fill"></i> –ü—Ä–æ–≤–µ—Ä–µ–Ω</span>
                    {% endif %}
                    {% if listing.seller.profile.total_sales > 20 %}
                    <span class="badge bg-primary"><i class="bi bi-star-fill"></i> –ù–∞–¥–µ–∂–Ω—ã–π</span>
                    {% endif %}
                    {% if listing.seller.profile.total_sales > 5 %}
                    <span class="badge bg-info"><i class="bi bi-lightning-fill"></i> –ë—ã—Å—Ç—Ä—ã–π</span>
                    {% endif %}
                </div>
                
                <div style="margin-top:15px;padding-top:15px;border-top:1px solid #dee2e6;">
                    <small class="text-muted">
                        <i class="bi bi-calendar"></i> –ù–∞ —Å–∞–π—Ç–µ —Å {{ listing.seller.date_joined|date:"F Y" }}
                    </small>
                </div>
            </div>
            
            <!-- Report link -->
            {% if user.is_authenticated and user != listing.seller %}
            <div class="text-center mt-3">
                <a href="{% url 'listings:report_listing' listing.pk %}" class="text-danger text-decoration-none small">
                    <i class="bi bi-flag"></i> –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Similar Listings Section -->
    {% if similar_listings %}
    <div class="similar-listings-section mt-5">
        <h3 class="mb-4"><i class="bi bi-grid-3x3-gap"></i> –ü–æ—Ö–æ–∂–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h3>
        <div class="row g-3">
            {% for similar in similar_listings %}
            <div class="col-md-3 col-6">
                <a href="{% url 'listings:listing_detail' similar.pk %}" class="text-decoration-none">
                    <div class="similar-listing-card">
                        {% if similar.image %}
                        <img src="{{ similar.image.url }}" alt="{{ similar.title }}" class="similar-listing-image">
                        {% else %}
                        <div class="similar-listing-image" style="display:flex;align-items:center;justify-content:center;background:#667eea;">
                            <i class="bi bi-image" style="font-size:48px;color:white;"></i>
                        </div>
                        {% endif %}
                        <div class="similar-listing-content">
                            <div class="similar-listing-title">{{ similar.title|truncatewords:5 }}</div>
                            <div class="similar-listing-price">{{ similar.price }} ‚ÇΩ</div>
                            <small class="text-muted">{{ similar.seller.username }}</small>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/favorites.js' %}"></script>
{% endblock %}
