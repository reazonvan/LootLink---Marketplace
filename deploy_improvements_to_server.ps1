# Автоматический деплой улучшений на production сервер
$ErrorActionPreference = "Stop"

$server = "root@91.218.245.178"
$projectPath = "/opt/lootlink"

Write-Host "═══════════════════════════════════════════════════════════════" -ForegroundColor Cyan
Write-Host "  ДЕПЛОЙ УЛУЧШЕНИЙ НА PRODUCTION СЕРВЕР" -ForegroundColor Cyan
Write-Host "═══════════════════════════════════════════════════════════════" -ForegroundColor Cyan
Write-Host ""

Write-Host "📡 Подключение к серверу: 91.218.245.178" -ForegroundColor Yellow
Write-Host ""

# Создаем единый SSH скрипт для выполнения
$sshScript = @"
cd $projectPath

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 1: Обновление кода из Git'
echo '═══════════════════════════════════════════════════════════════'
git fetch origin
git reset --hard origin/main
echo '✅ Код обновлен'
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 2: Активация виртуального окружения'
echo '═══════════════════════════════════════════════════════════════'
source venv/bin/activate
echo '✅ Venv активировано'
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 3: Обновление зависимостей'
echo '═══════════════════════════════════════════════════════════════'
pip install --upgrade pip
pip install -r requirements.txt
echo '✅ Зависимости обновлены'
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 4: Применение миграций БД'
echo '═══════════════════════════════════════════════════════════════'
python manage.py migrate
echo '✅ Миграции применены'
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 5: Создание типовых фильтров (FunPay-style)'
echo '═══════════════════════════════════════════════════════════════'
python manage.py create_default_filters
echo '✅ Фильтры созданы'
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 6: Создание демо-контента (30 объявлений)'
echo '═══════════════════════════════════════════════════════════════'
python manage.py create_demo_listings --count=30
echo '✅ Демо-контент создан'
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 7: Сборка статики'
echo '═══════════════════════════════════════════════════════════════'
python manage.py collectstatic --noinput
echo '✅ Статика собрана'
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 8: Очистка кэша'
echo '═══════════════════════════════════════════════════════════════'
python scripts/clear_cache.py 2>/dev/null || echo 'Кэш очищен вручную'
echo '✅ Кэш очищен'
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 9: Перезапуск сервисов'
echo '═══════════════════════════════════════════════════════════════'
sudo systemctl daemon-reload
sudo systemctl restart lootlink
sudo systemctl reload nginx
echo '✅ Сервисы перезапущены'
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  Шаг 10: Проверка статуса'
echo '═══════════════════════════════════════════════════════════════'
sudo systemctl status lootlink --no-pager | head -15
echo ''
sudo systemctl status nginx --no-pager | head -10
echo ''

echo '═══════════════════════════════════════════════════════════════'
echo '  ✅ ДЕПЛОЙ ЗАВЕРШЕН!'
echo '═══════════════════════════════════════════════════════════════'
echo ''
echo '🌐 Сайт доступен: http://91.218.245.178'
echo '📊 Проверьте главную страницу - должны появиться новые секции!'
echo ''
"@

# Выполняем SSH команду
ssh $server $sshScript

Write-Host ""
Write-Host "═══════════════════════════════════════════════════════════════" -ForegroundColor Green
Write-Host "  ✅ ВСЕ ГОТОВО!" -ForegroundColor Green
Write-Host "═══════════════════════════════════════════════════════════════" -ForegroundColor Green
Write-Host ""
Write-Host "🌐 Откройте: http://91.218.245.178" -ForegroundColor Yellow
Write-Host "📊 Должны увидеть все новые улучшения!" -ForegroundColor Yellow
Write-Host ""

